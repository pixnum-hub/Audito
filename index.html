<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéµ Audito - Mobile-first Neomorphic Music Player</title>
  <style>
    /* ---------- Mobile-first Responsive Neomorphic UI ---------- */

    :root {
      --bg: #111;
      --panel: #1a1a1a;
      --panel-inset: #1b1b1b;
      --accent: #00e0ff;
      --text: #eee;
    }

    * { box-sizing: border-box; }

    body {
      background: var(--bg);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .app-frame {
      width: 95%;
      max-width: 460px;
      background: var(--panel);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 12px 12px 28px rgba(0,0,0,0.7), -8px -8px 20px rgba(255,255,255,0.02);
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 16px auto;
    }

    /* header */
    .header-row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .header-row h2{ margin:0; font-size:18px; color:var(--accent); text-shadow:0 0 8px rgba(0,224,255,0.08); }

    /* file input */
    .file-row { display:flex; gap:8px; align-items:center; }
    input[type=file] { color:var(--text); }

    /* media container & canvas */
    #mediaContainer { width:100%; display:block; border-radius:10px; overflow:hidden; background:#000; }
    canvas { width:100%; height:100px; border-radius:12px; background:#0b0b0b; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.6); display:block; }

    /* seek bar */
    .seek-bar { width:100%; margin-top:6px; }
    .seek-bar input[type=range]{
      width:100%; -webkit-appearance:none; appearance:none;
      height:8px; border-radius:8px;
      background: linear-gradient(90deg,#222,#181818);
      box-shadow: inset 4px 4px 8px rgba(0,0,0,0.6);
    }
    .seek-bar input[type=range]::-webkit-slider-thumb {
      -webkit-appearance:none; width:16px; height:16px; border-radius:50%;
      background:var(--accent); box-shadow:0 0 12px rgba(0,224,255,0.6); cursor:pointer;
    }

    /* controls */
    .controls { display:flex; flex-wrap:wrap; justify-content:center; gap:8px; align-items:center; margin-top:6px; }
    .controls button {
      background: var(--panel-inset);
      color: var(--text);
      border: none;
      padding: 8px 12px;
      border-radius: 12px;
      box-shadow: 6px 6px 12px rgba(0,0,0,0.6), -6px -6px 12px rgba(255,255,255,0.02);
      cursor:pointer; font-size:14px;
    }
    .controls button:active {
      box-shadow: inset 6px 6px 12px rgba(0,0,0,0.6), inset -6px -6px 12px rgba(255,255,255,0.02);
      transform:scale(.98);
    }
    .controls select {
      background: var(--panel-inset); padding:8px; border-radius:10px;
      box-shadow: inset 4px 4px 8px rgba(0,0,0,0.6); border:none; color:var(--text);
    }

    /* volume */
    .volume-control { display:flex; align-items:center; gap:10px; background:var(--panel-inset); padding:8px; border-radius:12px; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.6), inset -6px -6px 12px rgba(255,255,255,0.02); }
    .volume-control input[type=range]{ width:80%; -webkit-appearance:none; height:6px; background:transparent; }
    .volume-control input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:var(--accent); box-shadow:0 0 12px rgba(0,224,255,0.6); cursor:pointer; }

    /* EQ (scrollable on small screens) */
    .eq {
      display:flex;
      align-items:flex-end;
      justify-content:flex-start;
      gap:12px;
      height:150px;
      padding:8px;
      border-radius:14px;
      background: var(--panel-inset);
      box-shadow: inset 8px 8px 14px rgba(0,0,0,0.6), inset -8px -8px 14px rgba(255,255,255,0.02);
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    .eq::-webkit-scrollbar{ height:8px }
    .eq::-webkit-scrollbar-thumb{ background: #333; border-radius:4px; }

    .eq input[type=range]{ writing-mode:bt-lr; -webkit-appearance:slider-vertical; width:28px; height:120px; border-radius:12px; background:#222; outline:none; box-shadow: 4px 4px 8px rgba(0,0,0,0.6), -4px -4px 8px rgba(255,255,255,0.02); }
    .eq input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:16px; height:16px; border-radius:50%; transition:transform .14s; }
    .eq input[type=range]:active{ transform:scale(1.04); }
    .eq input[type=range]:hover::-webkit-slider-thumb{ transform:scale(1.25); }

    /* per-band neon thumbs (11 bands) */
    .eq input:nth-child(1)::-webkit-slider-thumb{ background:#ff3b3b; box-shadow:0 0 10px #ff3b3b; }
    .eq input:nth-child(2)::-webkit-slider-thumb{ background:#ff7b00; box-shadow:0 0 10px #ff7b00; }
    .eq input:nth-child(3)::-webkit-slider-thumb{ background:#ffb300; box-shadow:0 0 10px #ffb300; }
    .eq input:nth-child(4)::-webkit-slider-thumb{ background:#00ff80; box-shadow:0 0 10px #00ff80; }
    .eq input:nth-child(5)::-webkit-slider-thumb{ background:#00d5ff; box-shadow:0 0 10px #00d5ff; }
    .eq input:nth-child(6)::-webkit-slider-thumb{ background:#007bff; box-shadow:0 0 10px #007bff; }
    .eq input:nth-child(7)::-webkit-slider-thumb{ background:#c800ff; box-shadow:0 0 10px #c800ff; }
    .eq input:nth-child(8)::-webkit-slider-thumb{ background:#ff00ff; box-shadow:0 0 10px #ff00ff; }
    .eq input:nth-child(9)::-webkit-slider-thumb{ background:#ff5ce2; box-shadow:0 0 10px #ff5ce2; }
    .eq input:nth-child(10)::-webkit-slider-thumb{ background:#00ffff; box-shadow:0 0 10px #00ffff; }
    .eq input:nth-child(11)::-webkit-slider-thumb{ background:#ffff00; box-shadow:0 0 10px #ffff00; }

    /* playlist & debug */
    .playlist { width:100%; max-height:120px; overflow-y:auto; padding:8px; border-radius:12px; background:#0f0f0f; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.6); color:#fff; }
    .playlist div{ padding:8px; border-radius:8px; cursor:pointer; }
    .playlist div:hover{ background:#222; }

    .debug-log { width:100%; height:72px; border-radius:10px; padding:8px; background:#000; color:#00ffcc; box-shadow: inset 4px 4px 8px rgba(0,0,0,0.6); overflow:auto; font-size:12px; }

    /* palette editor overlay */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; z-index:900; }
    .palette-editor { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:420px; max-width:96%; background:#151515; border-radius:12px; padding:12px; box-shadow: 16px 16px 40px rgba(0,0,0,0.7); z-index:1000; display:none; }

    /* responsive tweaks */
    @media (max-width: 720px){
      .app-frame { padding:12px; gap:8px; max-width:420px; }
      .eq { height:140px; }
      canvas { height:92px; }
      .controls button{ padding:8px 10px; min-width:52px; font-size:13px; }
    }

    @media (max-width:420px){
      .app-frame { max-width: 98%; padding:10px; }
      .eq { height:120px; gap:8px; }
      .eq input[type=range]{ width:22px; height:96px; }
      canvas { height:80px; }
      .controls button{ padding:6px 8px; min-width:44px; font-size:12px; }
      .playlist { max-height:100px; }
    }
  </style>
</head>
<body>
  <div class="app-frame" id="app">
    <!-- header -->
    <div class="header-row">
      <h2>üéµ Audito</h2>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="file" id="fileInput" multiple accept="audio/*,video/*" />
      </div>
    </div>

    <!-- media area -->
    <div id="mediaContainer"></div>

    <!-- seek bar container (seek bar element injected by script) -->
    <div class="seek-bar" id="seekBarContainer"></div>

    <!-- visualizer -->
    <canvas id="spectrum"></canvas>

    <!-- controls -->
    <div class="controls">
      <button id="prev">‚èÆ</button>
      <button id="play">‚ñ∂Ô∏è</button>
      <button id="pause">‚è∏</button>
      <button id="stop">‚èπ</button>
      <button id="next">‚è≠</button>

      <button id="loop">Loop: Off</button>

      <!-- Visualizer presets: current 4 only (Rainbow, Fire, Ocean, Neon) -->
      <select id="spectrumPreset" title="Visualizer preset">
        <option value="rainbow">Rainbow</option>
        <option value="fire">Fire</option>
        <option value="ocean">Ocean</option>
        <option value="neon">Neon</option>
      </select>

      <button id="editPalettes" title="Edit Custom Palettes" style="display:none;">Edit Palettes</button>
    </div>

    <!-- volume -->
    <div class="volume-control">
      <label style="color:#fff; margin-right:6px;">üîä</label>
      <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.3">
    </div>

    <!-- 11-band EQ (scrollable on small screens) -->
    <div class="eq" id="eq">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="60">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="170">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="350">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="1000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="3500">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="6000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="10000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="12000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="15000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="18000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="20000">
    </div>

    <!-- playlist and debug -->
    <div class="playlist" id="playlist"></div>
    <div class="debug-log" id="debugLog"></div>

    <div style="display:flex; justify-content:center; margin-top:6px;">
      <small style="color:#bbb;">¬© Manik Roy 2025. All Rights Reserved.</small>
    </div>
  </div>

  <!-- (palette editor omitted from UI since only 4 presets are used) -->
  <div class="overlay" id="overlay" style="display:none;"></div>
  <div class="palette-editor" id="paletteEditor" style="display:none;"></div>

  <script>
    /* ------------------ Core Player & Audio Graph ------------------ */
    let audioContext, analyser, sourceNode, masterGain, filters = [];
    let files = [], currentFileIndex = 0, currentMedia = null, loopMode = 0, audioContextStarted = false;

    const fileInput = document.getElementById('fileInput');
    const playlist = document.getElementById('playlist');
    const debugLog = document.getElementById('debugLog');
    const loopBtn = document.getElementById('loop');
    const volumeSlider = document.getElementById('volumeSlider');
    const spectrumPreset = document.getElementById('spectrumPreset');

    function log(msg){ debugLog.innerHTML += msg + '<br>'; debugLog.scrollTop = debugLog.scrollHeight; }

    /* Initialize AudioContext and analyzer */
    function initAudioContext(){
      if(!audioContext){
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;
        masterGain = audioContext.createGain();
        masterGain.gain.value = volumeSlider.value;
        masterGain.connect(analyser);
        analyser.connect(audioContext.destination);
        setupEQ();
        log('AudioContext initialized');
      }
    }

    /* Unlock audio context on first user interaction to satisfy autoplay policies */
    document.body.addEventListener('click', ()=> {
      if(!audioContextStarted){
        audioContextStarted = true;
        initAudioContext();
        if(audioContext.state === 'suspended') audioContext.resume();
      }
    }, { once:true });

    /* Volume changes */
    volumeSlider.oninput = ()=>{
      if(currentMedia) currentMedia.volume = volumeSlider.value;
      if(masterGain) masterGain.gain.value = volumeSlider.value;
      localStorage.setItem('audito_volume', volumeSlider.value);
      log('Volume set to ' + Math.round(volumeSlider.value*100) + '%');
    };

    /* EQ setup (11-band) */
    function setupEQ(){
      const eqSliders = document.querySelectorAll('.eq input');
      filters = [];
      eqSliders.forEach((slider)=>{
        const freq = parseFloat(slider.dataset.band);
        const filter = audioContext.createBiquadFilter();
        filter.type = 'peaking';
        filter.frequency.value = freq;
        filter.Q.value = (freq < 100) ? 1.2 : (freq < 1000 ? 1 : 0.5);
        filter.gain.value = parseFloat(slider.value);
        // store change if user adjusts (but we clear stored EQ defaults on load)
        slider.oninput = e => {
          filter.gain.value = parseFloat(e.target.value);
          // intentionally do NOT persist EQ to localStorage on load reset; but allow live use
        };
        filters.push(filter);
      });
      for(let i=0;i<filters.length-1;i++) filters[i].connect(filters[i+1]);
      if(filters.length) filters[filters.length-1].connect(masterGain);
    }

    /* Reset EQ sliders to neutral (0 dB) and clear any saved EQ keys */
    function resetEQDefaults() {
      const eqSliders = document.querySelectorAll('.eq input[type=range]');
      eqSliders.forEach(slider => {
        slider.value = 0; // neutral
        // remove any saved value for this band if present
        const freqKey = 'audito_eq_' + slider.dataset.band;
        try { localStorage.removeItem(freqKey); } catch(e) {}
      });
      log('EQ reset to default (0 dB) on app open');
    }

    /* Create media element and wire to audio graph */
    function createMediaElement(file){
      if(currentMedia){
        try{ currentMedia.pause(); currentMedia.remove(); } catch(e){ }
        if(sourceNode) sourceNode.disconnect();
      }

      const url = URL.createObjectURL(file);

      if(file.type.startsWith('video')){
        currentMedia = document.createElement('video');
        currentMedia.src = url; currentMedia.controls = true; currentMedia.style.width = '100%';
        currentMedia.volume = volumeSlider.value;
        document.getElementById('mediaContainer').innerHTML = '';
        document.getElementById('mediaContainer').appendChild(currentMedia);
        currentMedia.play().catch(()=>{});
      } else {
        currentMedia = document.createElement('audio');
        currentMedia.src = url; currentMedia.controls = true; currentMedia.style.width = '100%';
        currentMedia.volume = volumeSlider.value;
        document.getElementById('mediaContainer').innerHTML = '';
        document.getElementById('mediaContainer').appendChild(currentMedia);

        if(!audioContextStarted){ initAudioContext(); audioContextStarted = true; }
        sourceNode = audioContext.createMediaElementSource(currentMedia);
        if(filters.length>0) sourceNode.connect(filters[0]); else sourceNode.connect(masterGain);
        currentMedia.play().catch(()=>{});
      }

      currentMedia.onended = handleMediaEnd;
      currentMedia.ontimeupdate = ()=>{ if(currentMedia.duration) seekBar.value = (currentMedia.currentTime/currentMedia.duration)*100; };
      log('Loaded: ' + file.name);
    }

    /* playlist management */
    fileInput.onchange = e => {
      files = Array.from(e.target.files);
      buildPlaylist();
      if(files.length>0) loadFile(0);
    };
    function buildPlaylist(){
      playlist.innerHTML = '';
      files.forEach((f,i)=>{
        const d = document.createElement('div');
        d.textContent = f.name;
        d.onclick = ()=> loadFile(i);
        playlist.appendChild(d);
      });
    }

    /* control functions */
    function loadFile(i){ if(i<0||i>=files.length) return; currentFileIndex = i; createMediaElement(files[i]); highlightActive(); }
    function play(){ if(currentMedia) currentMedia.play().catch(()=>{}); log('Play'); }
    function pause(){ if(currentMedia) currentMedia.pause(); log('Pause'); }
    function stop(){ if(currentMedia){ currentMedia.pause(); currentMedia.currentTime = 0; } log('Stop'); }
    function next(){ if(files.length===0) return; loadFile((currentFileIndex+1) % files.length); play(); log('Next'); }
    function prev(){ if(files.length===0) return; loadFile((currentFileIndex-1+files.length) % files.length); play(); log('Prev'); }
    function highlightActive(){ [...playlist.children].forEach((el,i)=> el.classList.toggle('active', i===currentFileIndex)); playlist.children[currentFileIndex]?.scrollIntoView({behavior:'smooth', block:'center'}); }

    loopBtn.onclick = ()=>{ loopMode = (loopMode+1)%3; loopBtn.innerText = loopMode===0 ? 'Loop: Off' : loopMode===1 ? 'Loop: One' : 'Loop: All'; log('Loop set: ' + loopBtn.innerText); };
    function handleMediaEnd(){ if(loopMode===1) { currentMedia.currentTime = 0; currentMedia.play(); } else if(loopMode===2) next(); else stop(); }

    /* Seek bar element */
    const seekBar = document.createElement('input');
    seekBar.type = 'range'; seekBar.min = 0; seekBar.max = 100; seekBar.step = 0.1; seekBar.value = 0;
    seekBar.style.width = '100%'; seekBar.style.marginTop = '6px';
    seekBar.oninput = ()=>{ if(currentMedia && currentMedia.duration) currentMedia.currentTime = (seekBar.value/100)*currentMedia.duration; };
    document.getElementById('seekBarContainer').appendChild(seekBar);

    /* wire buttons */
    document.getElementById('play').onclick = play;
    document.getElementById('pause').onclick = pause;
    document.getElementById('stop').onclick = stop;
    document.getElementById('prev').onclick = prev;
    document.getElementById('next').onclick = next;

    /* ---------- Spectrum Visualizer (4 presets: Rainbow, Fire, Ocean, Neon) ---------- */
    const canvas = document.getElementById('spectrum');
    const ctx = canvas.getContext('2d');
    function resizeCanvas(){ canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    function getColor(i, preset){
      const percent = i / 256;
      switch(preset){
        case 'rainbow': return `hsl(${percent*360}, 100%, 50%)`;
        case 'fire':    return `rgb(${Math.min(255, percent*500)}, ${Math.min(255, percent*60)}, 0)`;
        case 'ocean':   return `rgb(0, ${Math.min(255, percent*255)}, ${Math.min(255, 255)})`;
        case 'neon':    return `rgb(${Math.min(255, 50+percent*205)},255,255)`;
        default: return `rgb(100,200,120)`;
      }
    }

    function drawSpectrum(){
      requestAnimationFrame(drawSpectrum);
      if(!analyser) return;
      const data = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(data);
      ctx.fillStyle = '#0b0b0b'; ctx.fillRect(0,0,canvas.width,canvas.height);
      const barWidth = (canvas.width / data.length) * 1.2;
      let x = 0;
      for(let i=0;i<data.length;i++){
        const h = data[i] / 2;
        ctx.fillStyle = getColor(i, spectrumPreset.value);
        ctx.fillRect(x, canvas.height - h, barWidth, h);
        x += barWidth + 1;
      }
    }
    drawSpectrum();

    /* ---------- Restore / Persistence (Volume only) ---------- */
    window.addEventListener('load', ()=> {
      // 1) Reset EQ sliders to neutral defaults on each app open
      resetEQDefaults();

      // 2) Load saved volume (if available)
      try {
        const vol = localStorage.getItem('audito_volume');
        if(vol !== null){
          volumeSlider.value = parseFloat(vol);
          if(masterGain) masterGain.gain.value = parseFloat(vol);
        }
      } catch(e) { /* ignore storage errors */ }

      // (Note: we intentionally do NOT restore EQ values from localStorage so EQ always starts neutral)
    });

    /* ---------- Drag & Drop support ---------- */
    const app = document.getElementById('app');
    app.addEventListener('dragover', e=> e.preventDefault());
    app.addEventListener('drop', e=>{
      e.preventDefault();
      const dt = e.dataTransfer;
      if(dt && dt.files && dt.files.length){
        files = Array.from(dt.files).filter(f=> f.type.startsWith('audio') || f.type.startsWith('video'));
        buildPlaylist();
        if(files.length) loadFile(0);
      }
    });

    /* ---------- Keyboard shortcuts ---------- */
    document.addEventListener('keydown', e=>{
      if(e.code === 'Space'){ e.preventDefault(); if(currentMedia && !currentMedia.paused) pause(); else play(); }
      if(e.key === 'ArrowRight') next();
      if(e.key === 'ArrowLeft') prev();
    });
  </script>
</body>
</html>
