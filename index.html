<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Audito - Unified Player</title>

  <style>
    /* ---------- Mobile-first Neomorphic UI + Adaptive Visualizer Height ---------- */
    :root{
      --bg:#0b0b0b;
      --panel:#1a1a1a;
      --panel-inset:#1b1b1b;
      --accent:#00e0ff;
      --text:#eee;
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg);
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
      margin:0;
      font-family:'Segoe UI',Arial,sans-serif;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }

    .app-frame{
      width:95%;
      max-width:920px;            /* wider on desktop but still constrained */
      background:var(--panel);
      border-radius:18px;
      padding:14px;
      box-shadow:12px 12px 28px rgba(0,0,0,0.7), -8px -8px 20px rgba(255,255,255,0.02);
      display:flex;
      flex-direction:column;
      gap:10px;
      margin:16px auto;
    }

    /* header - minimal (just title icon) */
    .header-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .header-row h2{ margin:0; font-size:18px; color:var(--accent); text-shadow:0 0 8px rgba(0,224,255,0.06) }

    input[type=file]{ color:var(--text) }

    /* media container */
    #mediaContainer{ width:100%; border-radius:10px; overflow:hidden; background:#000; display:flex; align-items:center; justify-content:center; min-height:48px; }

    /* seek bar */
    .seek-bar{ width:100%; margin-top:6px }
    .seek-bar input[type=range]{
      width:100%; -webkit-appearance:none; height:8px; border-radius:8px;
      background: linear-gradient(90deg,#222,#181818); box-shadow: inset 4px 4px 8px rgba(0,0,0,0.6);
    }
    .seek-bar input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none; width:16px; height:16px; border-radius:50%;
      background:var(--accent); box-shadow:0 0 12px rgba(0,224,255,0.6); cursor:pointer;
    }

    /* controls */
    .controls{ display:flex; flex-wrap:wrap; justify-content:center; gap:8px; align-items:center; margin-top:6px }
    .controls button{
      background:var(--panel-inset); color:var(--text); border:none; padding:8px 12px; border-radius:12px;
      box-shadow:6px 6px 12px rgba(0,0,0,0.6), -6px -6px 12px rgba(255,255,255,0.02);
      cursor:pointer; font-size:14px;
    }
    .controls button:active{
      box-shadow: inset 6px 6px 12px rgba(0,0,0,0.6), inset -6px -6px 12px rgba(255,255,255,0.02);
      transform:scale(.98);
    }
    .controls select{ background:var(--panel-inset); padding:8px; border-radius:10px; box-shadow:inset 4px 4px 8px rgba(0,0,0,0.6); border:none; color:var(--text) }

    /* volume */
    .volume-control{
      display:flex; align-items:center; gap:10px; background:var(--panel-inset); padding:8px; border-radius:12px;
      box-shadow: inset 6px 6px 12px rgba(0,0,0,0.6), inset -6px -6px 12px rgba(255,255,255,0.02);
    }
    .volume-control input[type=range]{ width:80%; -webkit-appearance:none; height:6px; background:transparent; }
    .volume-control input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:var(--accent); box-shadow:0 0 12px rgba(0,224,255,0.6); cursor:pointer;
    }

    /* --- EQ: NON-SCROLLABLE fixed layout --- */
    .eq{
      display:flex; align-items:flex-end; justify-content:space-between; gap:8px;
      height:150px; padding:8px 6px; border-radius:14px; background:var(--panel-inset);
      box-shadow: inset 8px 8px 14px rgba(0,0,0,0.6), inset -8px -8px 14px rgba(255,255,255,0.02);
      overflow: hidden;
    }
    .eq input[type=range]{
      writing-mode:bt-lr; -webkit-appearance:slider-vertical; width:26px; height:120px; border-radius:12px; background:#222;
      outline:none; box-shadow:4px 4px 8px rgba(0,0,0,0.6), -4px -4px 8px rgba(255,255,255,0.02);
    }
    .eq input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:16px; height:16px; border-radius:50%; transition:transform .14s }
    .eq input[type=range]:hover::-webkit-slider-thumb{ transform:scale(1.2) }

    /* neon thumbs colors */
    .eq input:nth-child(1)::-webkit-slider-thumb{ background:#ff3b3b; box-shadow:0 0 10px #ff3b3b }
    .eq input:nth-child(2)::-webkit-slider-thumb{ background:#ff7b00; box-shadow:0 0 10px #ff7b00 }
    .eq input:nth-child(3)::-webkit-slider-thumb{ background:#ffb300; box-shadow:0 0 10px #ffb300 }
    .eq input:nth-child(4)::-webkit-slider-thumb{ background:#00ff80; box-shadow:0 0 10px #00ff80 }
    .eq input:nth-child(5)::-webkit-slider-thumb{ background:#00d5ff; box-shadow:0 0 10px #00d5ff }
    .eq input:nth-child(6)::-webkit-slider-thumb{ background:#007bff; box-shadow:0 0 10px #007bff }
    .eq input:nth-child(7)::-webkit-slider-thumb{ background:#c800ff; box-shadow:0 0 10px #c800ff }
    .eq input:nth-child(8)::-webkit-slider-thumb{ background:#ff00ff; box-shadow:0 0 10px #ff00ff }
    .eq input:nth-child(9)::-webkit-slider-thumb{ background:#ff5ce2; box-shadow:0 0 10px #ff5ce2 }
    .eq input:nth-child(10)::-webkit-slider-thumb{ background:#00ffff; box-shadow:0 0 10px #00ffff }
    .eq input:nth-child(11)::-webkit-slider-thumb{ background:#ffff00; box-shadow:0 0 10px #ffff00 }

    /* playlist & debug */
    .playlist{ width:100%; max-height:200px; overflow-y:auto; padding:8px; border-radius:12px; background:#0f0f0f; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.6); color:#fff; }
    .playlist div{ padding:8px; border-radius:8px; cursor:pointer }
    .playlist div:hover{ background:#222 }
    .debug-log{ width:100%; height:72px; border-radius:10px; padding:8px; background:#000; color:#00ffcc; box-shadow: inset 4px 4px 8px rgba(0,0,0,0.6); overflow:auto; font-size:12px }

    /* Adaptive visualizer heights via CSS media queries */
    /* Keep canvas background solid dark (#0a0a0a) for contrast */
    #spectrum{ width:100%; display:block; background:#0a0a0a; border-radius:12px; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.6); }

    @media (max-width: 600px) {
      #spectrum{ height:130px; }  /* mobile */
      .eq{ height:130px }         /* keep proportions */
      .eq input[type=range]{ height:100px }
    }
    @media (min-width: 601px) and (max-width: 1024px) {
      #spectrum{ height:200px; }  /* tablet */
      .eq{ height:150px }
      .eq input[type=range]{ height:120px }
    }
    @media (min-width: 1025px) {
      #spectrum{ height:300px; }  /* desktop */
      .eq{ height:170px }
      .eq input[type=range]{ height:140px }
    }

    /* small adjustments on very narrow screens */
    @media (max-width:420px){
      .app-frame{ padding:10px }
      .controls button{ padding:6px 8px; font-size:12px }
      .playlist{ max-height:120px }
    }
  </style>
</head>
<body>
  <div class="app-frame" id="app">
    <div class="header-row">
      <h2>üéµ Audito</h2>
      <div>
        <input type="file" id="fileInput" multiple accept="audio/*,video/*" />
      </div>
    </div>

    <div id="mediaContainer"></div>

    <!-- Seek bar area (seek element injected by script) -->
    <div class="seek-bar" id="seekBarContainer"></div>

    <!-- Visualizer canvas (solid dark background) -->
    <canvas id="spectrum" aria-label="Audio visualizer"></canvas>

    <div class="controls">
      <button id="prev">‚èÆ</button>
      <button id="play">‚ñ∂Ô∏è</button>
      <button id="pause">‚è∏</button>
      <button id="stop">‚èπ</button>
      <button id="next">‚è≠</button>

      <button id="loop">Loop: Off</button>

      <select id="spectrumPreset" title="Visualizer preset">
        <option value="rainbow" selected>Rainbow</option>
        <option value="fire">Fire</option>
        <option value="ocean">Ocean</option>
        <option value="neon">Neon</option>
      </select>
    </div>

    <div class="volume-control">
      <label style="color:#fff; margin-right:6px;">üîä</label>
      <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.3">
    </div>

    <!-- Non-scrollable 11-band EQ -->
    <div class="eq" id="eq">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="60">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="170">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="350">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="1000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="3500">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="6000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="10000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="12000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="15000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="18000">
      <input type="range" min="-36" max="36" value="0" step="1" data-band="20000">
    </div>

    <div class="playlist" id="playlist"></div>
    <div class="debug-log" id="debugLog"></div>

    <div style="text-align:center; color:#bbb;">
      <small>¬© Manik Roy 2025. All Rights Reserved.</small>
    </div>
  </div>

  <script>
    /* ------------------ Core Player & Audio Graph ------------------ */
    let audioContext, analyser, sourceNode, masterGain, filters = [];
    let files = [], currentFileIndex = 0, currentMedia = null, loopMode = 0, audioContextStarted = false;

    const fileInput = document.getElementById('fileInput');
    const playlist = document.getElementById('playlist');
    const debugLog = document.getElementById('debugLog');
    const loopBtn = document.getElementById('loop');
    const volumeSlider = document.getElementById('volumeSlider');
    const spectrumPreset = document.getElementById('spectrumPreset');

    function log(msg){ debugLog.innerHTML += msg + '<br>'; debugLog.scrollTop = debugLog.scrollHeight; }

    /* Initialize AudioContext and analyzer */
    function initAudioContext(){
      if(!audioContext){
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;
        masterGain = audioContext.createGain();
        masterGain.gain.value = volumeSlider.value;
        masterGain.connect(analyser);
        analyser.connect(audioContext.destination);
        setupEQ();
        log('AudioContext initialized');
      }
    }

    /* Unlock audio context on first user interaction */
    document.body.addEventListener('click', ()=>{
      if(!audioContextStarted){
        audioContextStarted = true;
        initAudioContext();
        if(audioContext.state === 'suspended') audioContext.resume();
      }
    }, { once:true });

    /* Volume changes (persist) */
    volumeSlider.oninput = ()=>{
      if(currentMedia) currentMedia.volume = volumeSlider.value;
      if(masterGain) masterGain.gain.value = volumeSlider.value;
      try{ localStorage.setItem('audito_volume', volumeSlider.value); } catch(e){}
    };

    /* EQ setup (11-band) */
    function setupEQ(){
      const eqSliders = document.querySelectorAll('.eq input');
      filters = [];
      eqSliders.forEach((slider)=>{
        const freq = parseFloat(slider.dataset.band);
        const f = audioContext.createBiquadFilter();
        f.type = 'peaking';
        f.frequency.value = freq;
        f.Q.value = (freq < 100) ? 1.2 : (freq < 1000 ? 1 : 0.5);
        f.gain.value = parseFloat(slider.value);
        slider.oninput = e => { f.gain.value = parseFloat(e.target.value); };
        filters.push(f);
      });
      for(let i=0;i<filters.length-1;i++) filters[i].connect(filters[i+1]);
      if(filters.length) filters[filters.length-1].connect(masterGain);
    }

    /* Reset EQ sliders to neutral (0 dB) on open */
    function resetEQDefaults(){
      document.querySelectorAll('.eq input').forEach(s=>{
        s.value = 0;
        try{ localStorage.removeItem('audito_eq_' + s.dataset.band); } catch(e){}
      });
      log('EQ reset to default (0 dB) on app open');
    }

    /* Create media element and connect to audio graph */
    function createMediaElement(file){
      if(currentMedia){
        try{ currentMedia.pause(); currentMedia.remove(); }catch(e){}
        if(sourceNode) sourceNode.disconnect();
      }
      const url = URL.createObjectURL(file);
      if(file.type.startsWith('video')){
        currentMedia = document.createElement('video');
        currentMedia.src = url; currentMedia.controls = true; currentMedia.style.width = '100%';
        currentMedia.volume = volumeSlider.value;
        document.getElementById('mediaContainer').innerHTML = '';
        document.getElementById('mediaContainer').appendChild(currentMedia);
        currentMedia.play().catch(()=>{});
      } else {
        currentMedia = document.createElement('audio');
        currentMedia.src = url; currentMedia.controls = true; currentMedia.style.width = '100%';
        currentMedia.volume = volumeSlider.value;
        document.getElementById('mediaContainer').innerHTML = '';
        document.getElementById('mediaContainer').appendChild(currentMedia);

        if(!audioContextStarted){ initAudioContext(); audioContextStarted = true; }
        sourceNode = audioContext.createMediaElementSource(currentMedia);
        if(filters.length>0) sourceNode.connect(filters[0]); else sourceNode.connect(masterGain);
        currentMedia.play().catch(()=>{});
      }

      currentMedia.onended = handleMediaEnd;
      currentMedia.ontimeupdate = ()=>{ if(currentMedia.duration) seekBar.value = (currentMedia.currentTime/currentMedia.duration)*100; };
      log('Loaded: ' + file.name);
    }

    /* Playlist */
    fileInput.onchange = e => {
      files = Array.from(e.target.files);
      buildPlaylist();
      if(files.length>0) loadFile(0);
    };
    function buildPlaylist(){
      playlist.innerHTML = '';
      files.forEach((f,i)=>{
        const d = document.createElement('div');
        d.textContent = f.name;
        d.onclick = ()=> loadFile(i);
        playlist.appendChild(d);
      });
    }

    /* Player controls */
    function loadFile(i){ if(i<0||i>=files.length) return; currentFileIndex = i; createMediaElement(files[i]); highlightActive(); }
    function play(){ if(currentMedia) currentMedia.play().catch(()=>{}); log('Play'); }
    function pause(){ if(currentMedia) currentMedia.pause(); log('Pause'); }
    function stop(){ if(currentMedia){ currentMedia.pause(); currentMedia.currentTime = 0; } log('Stop'); }
    function next(){ if(files.length===0) return; loadFile((currentFileIndex+1) % files.length); play(); log('Next'); }
    function prev(){ if(files.length===0) return; loadFile((currentFileIndex-1+files.length) % files.length); play(); log('Prev'); }
    function highlightActive(){ [...playlist.children].forEach((el,i)=> el.classList.toggle('active', i===currentFileIndex)); playlist.children[currentFileIndex]?.scrollIntoView({behavior:'smooth', block:'center'}); }

    loopBtn.onclick = ()=>{ loopMode = (loopMode+1)%3; loopBtn.innerText = loopMode===0 ? 'Loop: Off' : loopMode===1 ? 'Loop: One' : 'Loop: All'; log('Loop set: ' + loopBtn.innerText); };
    function handleMediaEnd(){ if(loopMode===1){ currentMedia.currentTime = 0; currentMedia.play(); } else if(loopMode===2) next(); else stop(); }

    /* Seek bar */
    const seekBar = document.createElement('input');
    seekBar.type = 'range'; seekBar.min = 0; seekBar.max = 100; seekBar.step = 0.1; seekBar.value = 0;
    seekBar.style.width = '100%'; seekBar.style.marginTop = '6px';
    seekBar.oninput = ()=>{ if(currentMedia && currentMedia.duration) currentMedia.currentTime = (seekBar.value/100)*currentMedia.duration; };
    document.getElementById('seekBarContainer').appendChild(seekBar);

    document.getElementById('play').onclick = play;
    document.getElementById('pause').onclick = pause;
    document.getElementById('stop').onclick = stop;
    document.getElementById('prev').onclick = prev;
    document.getElementById('next').onclick = next;

    /* ---------- Bright steady-glow visualizer ---------- */
    const canvas = document.getElementById('spectrum');
    const ctx = canvas.getContext('2d');

    function resizeCanvas(){
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function brightColor(i, v, preset){
      // returns { fill, shadow }
      switch(preset){
        case 'fire':
          return {
            fill: `rgb(${Math.min(255, v + 150)}, ${Math.min(255, Math.round(v/1.8))}, ${Math.round(v/8)})`,
            shadow: `rgba(${Math.min(255, v + 180)}, ${Math.min(255, Math.round(v/1.6))}, ${Math.round(v/6)}, 0.85)`
          };
        case 'ocean':
          return {
            fill: `rgb(${Math.round(v/4)}, ${Math.min(255, v + 180)}, ${Math.min(255, v + 220)})`,
            shadow: `rgba(${Math.round(v/6)}, ${Math.min(255, v + 200)}, ${Math.min(255, v + 230)}, 0.9)`
          };
        case 'neon':
          return {
            fill: `rgb(${Math.min(255, v + 180)}, ${Math.round(v/3)}, ${Math.min(255, v + 220)})`,
            shadow: `rgba(${Math.min(255, v + 200)}, ${Math.round(v/4)}, ${Math.min(255, v + 230)}, 0.95)`
          };
        default: // rainbow
          const hue = (i / 256) * 360;
          const lightness = Math.min(80, 50 + v / 6);
          return {
            fill: `hsl(${hue}, 100%, ${lightness}%)`,
            shadow: `hsla(${hue}, 100%, ${Math.min(70, lightness+10)}%, 0.9)`
          };
      }
    }

    function drawSpectrum(){
      requestAnimationFrame(drawSpectrum);
      if(!analyser) return;
      const data = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(data);

      // Solid dark background
      ctx.fillStyle = '#0a0a0a';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      const barWidth = (canvas.width / data.length) * 1.12;
      let x = 0;
      const glow = 18; // steady blur for all bars
      for(let i=0;i<data.length;i++){
        const v = data[i];
        const col = brightColor(i, v, spectrumPreset.value);
        ctx.shadowBlur = glow;
        ctx.shadowColor = col.shadow;
        ctx.fillStyle = col.fill;
        const h = v / 1.6;
        ctx.fillRect(x, canvas.height - h, Math.max(1, barWidth - 1), h);
        x += barWidth + 1;
      }
      ctx.shadowBlur = 0;
    }
    drawSpectrum();

    /* ---------- Restore / Persistence ---------- */
    window.addEventListener('load', ()=>{
      // Reset EQ to neutral defaults immediately on load
      resetEQDefaults();

      // Restore volume from localStorage if available
      try{
        const vol = localStorage.getItem('audito_volume');
        if(vol !== null){
          volumeSlider.value = parseFloat(vol);
          if(masterGain) masterGain.gain.value = parseFloat(vol);
        }
      }catch(e){}
      resizeCanvas();
    });

    /* ---------- Drag & Drop ---------- */
    const app = document.getElementById('app');
    app.addEventListener('dragover', e=> e.preventDefault());
    app.addEventListener('drop', e=>{
      e.preventDefault();
      const dt = e.dataTransfer;
      if(dt && dt.files && dt.files.length){
        files = Array.from(dt.files).filter(f=> f.type.startsWith('audio') || f.type.startsWith('video'));
        buildPlaylist();
        if(files.length) loadFile(0);
      }
    });

    /* ---------- Keyboard shortcuts ---------- */
    document.addEventListener('keydown', e=>{
      if(e.code === 'Space'){ e.preventDefault(); if(currentMedia && !currentMedia.paused) pause(); else play(); }
      if(e.key === 'ArrowRight') next();
      if(e.key === 'ArrowLeft') prev();
    });
  </script>
</body>
</html>
