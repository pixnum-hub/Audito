<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéµ Audito - Adaptive Visualizer</title>
<style>
:root{
  --bg:#0b0b0b;
  --panel:#1a1a1a;
  --panel-inset:#1b1b1b;
  --accent:#00e0ff;
  --text:#eee;
}
*{box-sizing:border-box}
body{
  background:var(--bg);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  margin:0;
  font-family:'Segoe UI',Arial,sans-serif;
  color:var(--text);
  -webkit-font-smoothing:antialiased;
}
.app-frame{
  width:95%;
  max-width:460px;
  background:var(--panel);
  border-radius:18px;
  padding:14px;
  box-shadow:12px 12px 28px rgba(0,0,0,0.7), -8px -8px 20px rgba(255,255,255,0.02);
  display:flex;
  flex-direction:column;
  gap:10px;
  margin:16px auto;
}
.header-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.header-row h2{margin:0;font-size:18px;color:var(--accent);text-shadow:0 0 8px rgba(0,224,255,0.06)}
input[type=file]{color:var(--text)}
#mediaContainer{width:100%;border-radius:10px;overflow:hidden;background:#000}

/* Adaptive Visualizer Height */
canvas {
  width:100%;
  height: calc(15vh + 40px);
  border-radius:12px;
  background:#0a0a0a;
  box-shadow: inset 6px 6px 12px rgba(0,0,0,0.6);
  display:block;
}

.controls{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;align-items:center;margin-top:6px}
.controls button{
  background:var(--panel-inset);color:var(--text);border:none;padding:8px 12px;border-radius:12px;
  box-shadow:6px 6px 12px rgba(0,0,0,0.6), -6px -6px 12px rgba(255,255,255,0.02);
  cursor:pointer;font-size:14px;
}
.controls button:active{
  box-shadow: inset 6px 6px 12px rgba(0,0,0,0.6), inset -6px -6px 12px rgba(255,255,255,0.02);
  transform: scale(.98);
}
.controls select{
  background:var(--panel-inset);padding:8px;border-radius:10px;box-shadow:inset 4px 4px 8px rgba(0,0,0,0.6);
  border:none;color:var(--text)
}

.volume-control{
  display:flex;align-items:center;gap:10px;background:var(--panel-inset);padding:8px;border-radius:12px;
  box-shadow:inset 6px 6px 12px rgba(0,0,0,0.6), inset -6px -6px 12px rgba(255,255,255,0.02);
}
.volume-control input[type=range]{width:80%;-webkit-appearance:none;height:6px;background:transparent}
.volume-control input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);
  box-shadow:0 0 12px rgba(0,224,255,0.6);cursor:pointer;
}

.eq{
  display:flex;align-items:flex-end;justify-content:space-between;gap:8px;
  height:150px;padding:8px 6px;border-radius:14px;background:var(--panel-inset);
  box-shadow: inset 8px 8px 14px rgba(0,0,0,0.6), inset -8px -8px 14px rgba(255,255,255,0.02);
  overflow: hidden;
}
.eq input[type=range]{writing-mode:bt-lr;-webkit-appearance:slider-vertical;width:26px;height:120px;border-radius:12px;background:#222;outline:none;box-shadow:4px 4px 8px rgba(0,0,0,0.6), -4px -4px 8px rgba(255,255,255,0.02);}
.eq input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;transition:transform .14s}
.eq input[type=range]:hover::-webkit-slider-thumb{ transform:scale(1.2) }

.playlist{ width:100%; max-height:120px; overflow-y:auto; padding:8px; border-radius:12px; background:#0f0f0f; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.6); color:#fff; }
.playlist div{ padding:8px; border-radius:8px; cursor:pointer }
.playlist div:hover{ background:#222 }
.debug-log{ width:100%; height:72px; border-radius:10px; padding:8px; background:#000; color:#00ffcc; box-shadow: inset 4px 4px 8px rgba(0,0,0,0.6); overflow:auto; font-size:12px; }

@media (max-width:720px){ canvas{height:calc(12vh + 30px)} .eq{height:140px} }
@media (max-width:420px){ canvas{height:calc(10vh + 25px)} .eq{height:130px;gap:6px} .eq input[type=range]{width:22px;height:100px} .playlist{max-height:100px} }
</style>
</head>
<body>
<div class="app-frame" id="app">
  <div class="header-row">
    <h2>üéµ Audito</h2>
    <input type="file" id="fileInput" multiple accept="audio/*,video/*">
  </div>

  <div id="mediaContainer"></div>

  <canvas id="spectrum"></canvas>

  <div class="controls">
    <button id="prev">‚èÆ</button>
    <button id="play">‚ñ∂Ô∏è</button>
    <button id="pause">‚è∏</button>
    <button id="stop">‚èπ</button>
    <button id="next">‚è≠</button>
    <button id="loop">Loop: Off</button>
    <select id="spectrumPreset">
      <option value="rainbow">Rainbow</option>
      <option value="fire">Fire</option>
      <option value="ocean">Ocean</option>
      <option value="neon">Neon</option>
    </select>
  </div>

  <div class="volume-control">
    <label style="color:#fff; margin-right:6px;">üîä</label>
    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.3">
  </div>

  <div class="eq">
    <input type="range" min="-36" max="36" value="0" step="1" data-band="60">
    <input type="range" min="-36" max="36" value="0" step="1" data-band="170">
    <input type="range" min="-36" max="36" value="0" step="1" data-band="350">
    <input type="range" min="-36" max="36" value="0" step="1" data-band="1000">
    <input type="range" min="-36" max="36" value="0" step="1" data-band="3500">
    <input type="range" min="-36" max="36" value="0" step="1" data-band="6000">
    <input type="range" min="-36" max="36" value="0" step="1" data-band="10000">
    <input type="range" min="-36" max="36" value="0" step="1" data-band="12000">
    <input type="range" min="-36" max="36" value="0" step="1" data-band="15000">
    <input type="range" min="-36" max="36" value="0" step="1" data-band="18000">
    <input type="range" min="-36" max="36" value="0" step="1" data-band="20000">
  </div>

  <div class="playlist" id="playlist"></div>
  <div class="debug-log" id="debugLog"></div>

  <div style="text-align:center; color:#bbb;">
    <small>¬© Manik Roy 2025. All Rights Reserved.</small>
  </div>
</div>

<script>
let audioContext, analyser, sourceNode, masterGain, filters=[];
let files=[], currentFileIndex=0, currentMedia=null, loopMode=0, audioContextStarted=false;
const fileInput=document.getElementById('fileInput');
const playlist=document.getElementById('playlist');
const debugLog=document.getElementById('debugLog');
const loopBtn=document.getElementById('loop');
const volumeSlider=document.getElementById('volumeSlider');
const spectrumPreset=document.getElementById('spectrumPreset');

function log(msg){ debugLog.innerHTML+=msg+'<br>'; debugLog.scrollTop=debugLog.scrollHeight; }

function initAudioContext(){
  if(!audioContext){
    audioContext=new (window.AudioContext||window.webkitAudioContext)();
    analyser=audioContext.createAnalyser();
    analyser.fftSize=512;
    masterGain=audioContext.createGain();
    masterGain.gain.value=volumeSlider.value;
    masterGain.connect(analyser);
    analyser.connect(audioContext.destination);
    setupEQ();
    log('AudioContext initialized');
  }
}

document.body.addEventListener('click',()=>{
  if(!audioContextStarted){
    audioContextStarted=true;
    initAudioContext();
    if(audioContext.state==='suspended') audioContext.resume();
  }
},{once:true});

volumeSlider.oninput=()=>{
  if(currentMedia) currentMedia.volume=volumeSlider.value;
  if(masterGain) masterGain.gain.value=volumeSlider.value;
};

function setupEQ(){
  const eqSliders=document.querySelectorAll('.eq input');
  filters=[];
  eqSliders.forEach(slider=>{
    const freq=parseFloat(slider.dataset.band);
    const f=audioContext.createBiquadFilter();
    f.type='peaking';
    f.frequency.value=freq;
    f.Q.value=(freq<100)?1.2:(freq<1000?1:0.5);
    f.gain.value=parseFloat(slider.value);
    slider.oninput=e=>{ f.gain.value=parseFloat(e.target.value); };
    filters.push(f);
  });
  for(let i=0;i<filters.length-1;i++) filters[i].connect(filters[i+1]);
  if(filters.length) filters[filters.length-1].connect(masterGain);
}

function resetEQDefaults(){
  document.querySelectorAll('.eq input').forEach(s=>{ s.value=0; });
  log('EQ reset to default (0 dB) on app open');
}

function createMediaElement(file){
  if(currentMedia){ try{ currentMedia.pause(); currentMedia.remove(); }catch(e){} if(sourceNode) sourceNode.disconnect(); }
  const url=URL.createObjectURL(file);
  if(file.type.startsWith('video')){
    currentMedia=document.createElement('video');
    currentMedia.src=url; currentMedia.controls=true; currentMedia.style.width='100%';
    currentMedia.volume=volumeSlider.value;
    document.getElementById('mediaContainer').innerHTML='';
    document.getElementById('mediaContainer').appendChild(currentMedia);
    currentMedia.play().catch(()=>{});
  } else {
    currentMedia=document.createElement('audio');
    currentMedia.src=url; currentMedia.controls=true; currentMedia.style.width='100%';
    currentMedia.volume=volumeSlider.value;
    document.getElementById('mediaContainer').innerHTML='';
    document.getElementById('mediaContainer').appendChild(currentMedia);
    if(!audioContextStarted){ initAudioContext(); audioContextStarted=true; }
    sourceNode=audioContext.createMediaElementSource(currentMedia);
    if(filters.length>0) sourceNode.connect(filters[0]); else sourceNode.connect(masterGain);
    currentMedia.play().catch(()=>{});
  }
  currentMedia.onended=handleMediaEnd;
  currentMedia.ontimeupdate=()=>{ if(currentMedia.duration) seekBar.value=(currentMedia.currentTime/currentMedia.duration)*100; };
}

fileInput.onchange=e=>{
  files=Array.from(e.target.files);
  buildPlaylist();
  if(files.length>0) loadFile(0);
};

function buildPlaylist(){
  playlist.innerHTML='';
  files.forEach((f,i)=>{
    const d=document.createElement('div');
    d.textContent=f.name;
    d.onclick=()=> loadFile(i);
    playlist.appendChild(d);
  });
}

function loadFile(i){ if(i<0||i>=files.length) return; currentFileIndex=i; createMediaElement(files[i]); }
function play(){ if(currentMedia) currentMedia.play().catch(()=>{}); log('Play'); }
function pause(){ if(currentMedia) currentMedia.pause(); log('Pause'); }
function stop(){ if(currentMedia){ currentMedia.pause(); currentMedia.currentTime=0; } log('Stop'); }
function next(){ if(files.length===0) return; loadFile((currentFileIndex+1)%files.length); play(); log('Next'); }
function prev(){ if(files.length===0) return; loadFile((currentFileIndex-1+files.length)%files.length); play(); log('Prev'); }

loopBtn.onclick=()=>{ loopMode=(loopMode+1)%3; loopBtn.innerText=loopMode===0?'Loop: Off':loopMode===1?'Loop: One':'Loop: All'; log('Loop set: '+loopBtn.innerText); };
function handleMediaEnd(){ if(loopMode===1){ play(); } else if(loopMode===2){ next(); } else { stop(); } }

document.getElementById('play').onclick=play;
document.getElementById('pause').onclick=pause;
document.getElementById('stop').onclick=stop;
document.getElementById('prev').onclick=prev;
document.getElementById('next').onclick=next;

// --- Spectrum Visualizer ---
const canvas=document.getElementById('spectrum');
const ctx=canvas.getContext('2d');
function resizeCanvas(){
  canvas.width=canvas.offsetWidth;
  canvas.height=Math.max(80,window.innerHeight*0.15);
}
window.addEventListener('resize',resizeCanvas);
resizeCanvas();

function getColor(i,preset){
  const pct=i/256;
  switch(preset){
    case 'rainbow': return `hsl(${pct*360},100%,55%)`;
    case 'fire': return `rgb(${Math.min(255,pct*500)},${Math.min(255,pct*50)},0)`;
    case 'ocean': return `rgb(0,${Math.min(255,pct*255)},${Math.min(255,pct*255)})`;
    case 'neon': return `rgb(${Math.min(255,50+pct*205)},255,255)`;
    default: return '#0ff';
  }
}

function drawSpectrum(){
  requestAnimationFrame(drawSpectrum);
  if(!analyser) return;
  const dataArray=new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(dataArray);
  ctx.fillStyle='#0a0a0a';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  const totalBars = dataArray.length;
  const gap = 1;
  const barWidth = (canvas.width - (totalBars-1)*gap)/totalBars;
  let x=0;
  for(let i=0;i<totalBars;i++){
    let barHeight=dataArray[i]/1.5;
    ctx.fillStyle=getColor(i,spectrumPreset.value);
    ctx.fillRect(x,canvas.height-barHeight,barWidth,barHeight);
    x+=barWidth+gap;
  }
}
drawSpectrum();

// Initialize EQ default
resetEQDefaults();
</script>
</body>
</html>
